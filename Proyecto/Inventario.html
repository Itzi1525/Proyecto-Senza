<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventario - Senza Repostería</title>
<link rel="icon" type="image/png" href="Imagenes/Senza.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
    body { 
        font-family: 'Poppins', sans-serif; 
        margin: 0; 
        background: #f5f5f5; 
        color: #4B3832;
    }

    /* BARRA SUPERIOR (NUEVO) */
    .top-bar {
        background-color: #fff;
        padding: 15px 40px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        margin-bottom: 30px;
    }

    .btn-back {
        text-decoration: none;
        background-color: #4B3832;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: 0.3s;
    }

    .btn-back:hover {
        background-color: #382D26;
        transform: translateX(-3px); /* Pequeño efecto de movimiento */
    }

    /* CONTENEDOR PRINCIPAL */
    .container {
        padding: 0 40px 40px;
    }

    /* TABLA */
    table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
    th, td { padding: 15px; text-align: center; vertical-align: middle; border-bottom: 1px solid #eee; }
    th { background-color: #D2B48C; color: #fff; font-weight: bold; text-transform: uppercase; font-size: 0.9em; }
    tr:last-child td { border-bottom: none; }
    tr:hover { background-color: #fafafa; }

    /* IMÁGENES */
    .img-cell img { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; border: 1px solid #ddd; }

    /* BOTONES ACCIONES */
    button { cursor: pointer; border: none; padding: 8px 12px; border-radius: 4px; font-weight: bold; transition: 0.3s; }
    .btn-mod { background-color: #ffc107; color: #333; margin-right: 5px; }
    .btn-mod:hover { background-color: #e0a800; }
    .btn-del { background-color: #dc3545; color: white; }
    .btn-del:hover { background-color: #c82333; }
    
    /* FORMULARIO AGREGAR */
    #addForm { background: #fff; padding: 30px; margin-top: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); max-width: 900px; margin-left: auto; margin-right: auto; }
    #addForm h2 { margin-top: 0; color: #4B3832; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 20px; }
    
    .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    
    input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-family: 'Poppins'; }
    input:focus { outline: none; border-color: #D2B48C; }

    .btn-add { background-color: #28a745; color: white; padding: 12px 30px; font-size: 1em; margin-top: 20px; width: 100%; }
    .btn-add:hover { background-color: #218838; }

    /* MODAL */
    #modalProducto { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index: 1000; }
    #modalContent { background:#fff; padding:30px; border-radius:10px; width:90%; max-width:400px; position:relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .form-group { margin-bottom: 15px; text-align: left; }
    label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; font-size: 0.9em; }
</style>
</head>
<body>

<div class="top-bar">
    <div style="display: flex; align-items: center; gap: 15px;">
        <img src="Imagenes/Senza.png" alt="Logo" style="height: 40px;">
        <h2 style="margin:0;">Gestión de Inventario</h2>
    </div>
    
    <a href="AdminOpera.html" class="btn-back">
        <i class="fas fa-arrow-left"></i> Regresar al Panel
    </a>
</div>

<div class="container">

    <table id="tablaProductos">
        <thead>
            <tr>
                <th>ID</th>
                <th>Producto</th>
                <th>Precio</th>
                <th>Stock</th>
                <th>Imagen</th>
                <th>Descripción</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>

    <div id="addForm">
        <h2><i class="fas fa-plus-circle"></i> Agregar Nuevo Producto</h2>
        <div class="grid-form">
            <input type="text" id="nuevoNombre" placeholder="Nombre del producto">
            <input type="text" id="nuevaCategoria" placeholder="Categoría (ej. Pasteles)">
            <input type="number" id="nuevoPrecio" placeholder="Precio ($)">
            <input type="number" id="nuevoStock" placeholder="Stock (Cantidad)">
            
            <input type="text" id="nuevaImagen" placeholder="URL de la imagen (ej: Imagenes/pastel.jpg)" style="grid-column: span 2;">
            
            <input type="text" id="nuevaDescripcion" placeholder="Descripción breve" style="grid-column: span 2;">
        </div>
        <div style="text-align: center;">
            <button class="btn-add" onclick="agregarProducto()">Guardar Producto</button>
        </div>
    </div>

</div>

<div id="modalProducto">
    <div id="modalContent">
        <h2 style="text-align:center; margin-top:0;">Editar Producto</h2>
        
        <div class="form-group"><label>Nombre:</label><input type="text" id="modNombre"></div>
        <div class="form-group"><label>Precio:</label><input type="number" id="modPrecio"></div>
        <div class="form-group"><label>Stock:</label><input type="number" id="modStock"></div>
        <div class="form-group"><label>Imagen URL:</label><input type="text" id="modImagen"></div>
        <div class="form-group"><label>Descripción:</label><input type="text" id="modDescripcion"></div>
        <div class="form-group"><label>Categoría:</label><input type="text" id="modCategoria"></div>

        <div style="text-align: center; margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
            <button onclick="guardarModificacion()" style="background-color: #28a745; color: white; padding: 10px 20px; flex:1;">Guardar</button>
            <button onclick="cerrarModal()" style="background-color: #6c757d; color: white; padding: 10px 20px; flex:1;">Cancelar</button>
        </div>
    </div>
</div>

<script>
const apiUrl = "/api/productos";
let productoActualId = null;

// --- Cargar productos ---
function cargarProductos() {
    fetch(apiUrl)
        .then(res => {
            if (!res.ok) throw new Error("Error en la conexión con el servidor");
            return res.json();
        })
        .then(data => {
            const tbody = document.querySelector("#tablaProductos tbody");
            tbody.innerHTML = "";

            if(data.length === 0) {
                tbody.innerHTML = "<tr><td colspan='7' style='padding:20px; color:#888;'>No hay productos registrados</td></tr>";
                return;
            }

            data.forEach(prod => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${prod.id_producto}</td>
                    <td style="font-weight:600;">${prod.nombre}</td>
                    <td>$${prod.precio}</td> 
                    <td>
                        <span style="background:${prod.stock < 5 ? '#ffebee' : '#e8f5e9'}; color:${prod.stock < 5 ? '#c62828' : '#2e7d32'}; padding:4px 10px; border-radius:15px; font-weight:bold;">
                            ${prod.stock !== undefined ? prod.stock : 0}
                        </span>
                    </td>
                    <td class="img-cell"><img src="${prod.imagen}" alt="img" onerror="this.src='Imagenes/Senza.png'"></td> 
                    <td style="font-size:0.9em; color:#666;">${prod.descripcion || "-"}</td>
                    <td>
                        <button class="btn-mod" onclick="abrirModalModificar(${prod.id_producto})" title="Editar"><i class="fas fa-edit"></i></button>
                        <button class="btn-del" onclick="eliminarProducto(${prod.id_producto})" title="Borrar"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        })
        .catch(err => console.error("Error cargando productos:", err));
}

// --- Eliminar producto ---
function eliminarProducto(id) {
    if(!confirm("¿Seguro que deseas eliminar este producto?")) return;

    fetch(`${apiUrl}/${id}`, { method: "DELETE" })
        .then(res => res.json())
        .then(data => {
            if(data.success) cargarProductos();
            else alert("Error al eliminar: " + data.message);
        })
        .catch(err => console.error(err));
}

// --- Agregar producto (Versión JSON/Texto) ---
function agregarProducto() {
    const nombre = document.getElementById("nuevoNombre").value.trim();
    const precio = parseFloat(document.getElementById("nuevoPrecio").value);
    const stock = parseInt(document.getElementById("nuevoStock").value);
    const imagen = document.getElementById("nuevaImagen").value.trim(); 
    const descripcion = document.getElementById("nuevaDescripcion").value.trim();
    const categoria = document.getElementById("nuevaCategoria").value.trim();

    if(!nombre || isNaN(precio) || !imagen) {
        alert("Nombre, Precio e Imagen (URL) son obligatorios.");
        return;
    }

    fetch(apiUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
            nombre, precio, stock: stock || 0, imagen, descripcion, categoria 
        })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success) {
            alert("✅ Producto agregado");
            // Limpiar campos
            document.querySelectorAll('#addForm input').forEach(input => input.value = '');
            cargarProductos();
        } else {
            alert("Error: " + data.message);
        }
    })
    .catch(err => console.error(err));
}

// --- Abrir Modal ---
function abrirModalModificar(id) {
    productoActualId = id;
    
    fetch(apiUrl)
        .then(res => res.json())
        .then(data => {
            const prod = data.find(p => p.id_producto === id);
            if (!prod) return alert("Producto no encontrado.");

            document.getElementById("modNombre").value = prod.nombre;
            document.getElementById("modPrecio").value = prod.precio;
            document.getElementById("modStock").value = prod.stock || 0;
            document.getElementById("modImagen").value = prod.imagen;
            document.getElementById("modDescripcion").value = prod.descripcion || "";
            document.getElementById("modCategoria").value = prod.categoria || "";

            document.getElementById("modalProducto").style.display = "flex";
        });
}

// --- Guardar cambios del modal ---
function guardarModificacion() {
    const nombre = document.getElementById("modNombre").value.trim();
    const precio = parseFloat(document.getElementById("modPrecio").value);
    const stock = parseInt(document.getElementById("modStock").value);
    const imagen = document.getElementById("modImagen").value.trim();
    const descripcion = document.getElementById("modDescripcion").value.trim();
    const categoria = document.getElementById("modCategoria").value.trim();

    fetch(`${apiUrl}/${productoActualId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nombre, precio, stock, imagen, descripcion, categoria })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success) {
            cerrarModal();
            cargarProductos();
        } else {
            alert("Error al actualizar: " + data.message);
        }
    })
    .catch(err => console.error(err));
}

function cerrarModal() {
    document.getElementById("modalProducto").style.display = "none";
}

document.addEventListener("DOMContentLoaded", cargarProductos);
</script>

</body>
</html>