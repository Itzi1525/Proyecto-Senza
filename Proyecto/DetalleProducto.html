<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle de Producto | Senza</title>
    <link rel="icon" type="image/png" href="Imagenes/Senza.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

        
        :root {
            --color-primary: #D2B48C; /* Caf√© claro */
            --color-secondary: #4B3832; /* Caf√© oscuro */
            --color-background: #F8F8F8; /* Blanco muy sutil */
            --color-card-bg: #FFFFFF; /* Blanco puro */
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--color-background);
            color: var(--color-secondary);
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        /* Header (Igual al inicio) */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
            background-color: var(--color-card-bg);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .logo h1 {
            font-size: 1.5em;
            margin: 0;
            font-weight: 600;
        }

        .main-nav ul {
            display: flex;
            list-style: none;
            gap: 20px;
            padding: 0;
            margin: 0;
        }

        .main-nav a {
            text-decoration: none;
            color: var(--color-secondary);
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .main-nav a:hover {
            color: var(--color-primary);
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        /* --- ESTILOS ESPEC√çFICOS DE DETALLE --- */
        
        /* Layout principal */
        .detail-wrapper {
            display: flex;
            gap: 50px;
            flex-wrap: wrap;
            background-color: var(--color-card-bg);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.05);
        }

        /* Imagen */
        .product-img-container {
            flex: 1;
            min-width: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--color-background); /* Fondo sutil detr√°s de la imagen */
            border-radius: 10px;
            padding: 20px;
        }

        .product-img-container img {
            width: 100%;
            max-width: 450px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        /* Informaci√≥n */
        .product-info {
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .product-info h2 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: var(--color-secondary);
            text-transform: capitalize;
        }

        .price {
            font-size: 2em;
            color: var(--color-primary); /* Tu color caf√© claro */
            font-weight: 700;
            margin: 10px 0;
        }

        .stars-display {
            color: #FFD700; /* Oro para estrellas */
            font-size: 1.2em;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .description {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 30px;
        }

        /* Bot√≥n estilo Senza */
        .btn-add {
            background-color: var(--color-secondary);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: fit-content;
        }

        .btn-add:hover {
            background-color: #382D26; /* Un poco m√°s oscuro */
        }

        /* --- SECCI√ìN DE RESE√ëAS --- */
        .reviews-section {
            margin-top: 50px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .reviews-section h3 {
            text-align: center;
            font-size: 2em;
            margin-bottom: 30px;
            color: var(--color-secondary);
        }
        
        /* Formulario de rese√±a */
        .review-form {
            background: var(--color-card-bg);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-bottom: 40px;
            border: 1px solid #e0caa1;
        }

        .review-form h4 {
            margin-top: 0;
            color: var(--color-secondary);
        }
        
        .star-rating {
            font-size: 2em;
            color: #ddd;
            cursor: pointer;
            display: inline-block;
            margin-bottom: 15px;
        }

        .star-rating span:hover,
        .star-rating span.active {
            color: #FFD700;
        }
        
        textarea {
            width: 100%;
            height: 100px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--color-primary); /* Borde caf√© claro */
            border-radius: 5px;
            font-family: 'Poppins', sans-serif;
            resize: none;
            box-sizing: border-box;
            background-color: var(--color-background);
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--color-secondary);
        }

        .btn-submit-review {
            background-color: var(--color-primary);
            color: var(--color-secondary);
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-submit-review:hover {
            background-color: #c0a075;
            color: white;
        }

        /* Lista de rese√±as */
        .review-card {
            background: var(--color-card-bg);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-left: 4px solid var(--color-primary); /* Detalle visual */
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--color-secondary);
        }

        .review-stars { color: #FFD700; }
        .review-date { font-size: 0.85em; color: #999; margin-bottom: 10px; }

    </style>
</head>
<body>

<header>
    <div class="logo">
        <h1>Senza</h1>
    </div>
    <nav class="main-nav">
        <ul>
            <li><a href="Inicio.html">Inicio</a></li>
            <li><a href="03-productos.html">Men√∫</a></li>
            <li><a href="Carrito.html">Carrito</a></li>
            <li><a href="#">Cuenta</a></li>
        </ul>
    </nav>
</header>

<div class="container">
    
    <div class="detail-wrapper">
        <div class="product-img-container">
            <img id="imgProd" src="" alt="Cargando imagen...">
        </div>
        
        <div class="product-info">
            <h2 id="nameProd">Cargando...</h2>
            <div class="stars-display">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ (4.5)</div>
            <p class="price" id="priceProd">--</p>
            <p class="description" id="descProd">...</p>
            
            <button class="btn-add" id="btnAdd">Agregar al Carrito</button>
        </div>
    </div>

    <div class="reviews-section">
        <h3>Opiniones de nuestros clientes</h3>

        <div class="review-form">
            <h4>Deja tu rese√±a</h4>
            <div class="star-rating" id="starRating">
                <span data-value="1">‚òÖ</span>
                <span data-value="2">‚òÖ</span>
                <span data-value="3">‚òÖ</span>
                <span data-value="4">‚òÖ</span>
                <span data-value="5">‚òÖ</span>
            </div>
            <textarea id="reviewComment" placeholder="¬øQu√© te pareci√≥ este postre? Cu√©ntanos tu experiencia..."></textarea>
            <button class="btn-submit-review" id="btnSubmitReview">Publicar Rese√±a</button>
        </div>

        <div id="reviewsList" class="reviews-list">
            </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // ==========================================
        // 1. CARGAR DATOS DEL PRODUCTO
        // ==========================================
        const params = new URLSearchParams(window.location.search);
        
        const id = params.get('id'); 
        const nombre = params.get('nombre');
        const precio = params.get('precio');
        const desc = params.get('desc');
        const img = params.get('img');

        // Validamos que venga informaci√≥n
        if (nombre) {
            document.getElementById('nameProd').textContent = nombre;
            document.getElementById('priceProd').textContent = "$" + precio;
            document.getElementById('descProd').textContent = desc || "Descripci√≥n no disponible.";
            document.getElementById('imgProd').src = img;
            
            // --- LOGICA DEL CARRITO (Se mantiene igual, local) ---
            document.getElementById('btnAdd').addEventListener('click', () => {
                let cart = JSON.parse(localStorage.getItem('cart')) || [];
                let prodId = id ? Number(id) : null;
                
                let existing = null;
                if(prodId) {
                    existing = cart.find(p => p.id_producto === prodId);
                } else {
                    existing = cart.find(p => p.nombre === nombre);
                }

                if(existing) { 
                    existing.cantidad++; 
                } else { 
                    cart.push({ 
                        id_producto: prodId,
                        nombre: nombre, 
                        precio: Number(precio), 
                        cantidad: 1 
                    }); 
                }
                
                localStorage.setItem('cart', JSON.stringify(cart));
                alert("¬°" + nombre + " agregado al carrito! üõí");
            });

            // Cargar rese√±as DESDE LA BASE DE DATOS al iniciar
            loadReviews(nombre);

        } else {
             document.querySelector('.detail-wrapper').innerHTML = 
             "<h2 style='text-align:center;'>‚ö†Ô∏è Error: No se ha seleccionado producto. <br><a href='03-productos.html'>Volver</a></h2>";
        }

        // ==========================================
        // 2. L√ìGICA DE ESTRELLAS (Rating UI)
        // ==========================================
        let selectedRating = 0;
        const stars = document.querySelectorAll('#starRating span');

        stars.forEach(star => {
            star.addEventListener('click', function() {
                selectedRating = this.getAttribute('data-value');
                updateStars(selectedRating);
            });
        });

        function updateStars(rating) {
            stars.forEach(star => {
                if(star.getAttribute('data-value') <= rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        // ==========================================
        // 3. PUBLICAR RESE√ëA (CONECTADO A PYTHON/AWS)
        // ==========================================
        document.getElementById('btnSubmitReview').addEventListener('click', () => {
            
            // A) VALIDACIONES
            const comment = document.getElementById('reviewComment').value;
            const usuarioNombre = localStorage.getItem('usuarioNombre'); 
            const usuarioRol = localStorage.getItem('usuarioRol') || 'Cliente'; 

            if (!usuarioNombre) {
                alert("Debes iniciar sesi√≥n para comentar.");
                return;
            }

            if (selectedRating === 0) {
                alert("Por favor selecciona una calificaci√≥n (estrellas).");
                return;
            }
            if (comment.trim() === "") {
                alert("Por favor escribe tu opini√≥n.");
                return;
            }

            // B) CREAR EL OBJETO PARA ENVIAR A PYTHON
            const nuevaResena = {
                id_producto: nombre, // Usamos el nombre del producto
                autor: usuarioNombre,
                rol: usuarioRol,
                calificacion: selectedRating,
                comentario: comment
            };

            // C) GUARDAR EN BASE DE DATOS
            guardarResena(nuevaResena);
        });

        function guardarResena(resena) {
            // Conexi√≥n real a tu app2.py
            fetch('/api/resenas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    producto: resena.id_producto,
                    autor: resena.autor,
                    rol: resena.rol,
                    calificacion: resena.calificacion,
                    comentario: resena.comentario
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("¬°Gracias! Tu rese√±a se ha guardado en la BD. ‚úÖ");
                    
                    // Limpieza
                    document.getElementById('reviewComment').value = "";
                    selectedRating = 0;
                    updateStars(0);
                    
                    // Recargamos la lista desde la BD
                    loadReviews(resena.id_producto);
                } else {
                    alert("Error al guardar: " + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Error de conexi√≥n con el servidor.");
            });
        }

        // ==========================================
        // 4. MOSTRAR RESE√ëAS (DESDE PYTHON)
        // ==========================================
        function loadReviews(productName) {
            const reviewsContainer = document.getElementById('reviewsList');
            reviewsContainer.innerHTML = "<p>Cargando opiniones...</p>"; 
            
            // Solicitamos a Python las rese√±as de este producto
            fetch(`/api/resenas?producto=${encodeURIComponent(productName)}`)
                .then(response => response.json())
                .then(reviews => {
                    reviewsContainer.innerHTML = ""; // Limpiar mensaje de carga

                    if (!reviews || reviews.length === 0) {
                        reviewsContainer.innerHTML = "<p style='color:#888; text-align:center; font-style:italic;'>A√∫n no hay rese√±as. ¬°S√© el primero en opinar!</p>";
                        return;
                    }

                    reviews.forEach(r => {
                        // Estrellas
                        let starsHTML = "";
                        for(let i=0; i<5; i++) {
                            starsHTML += i < r.calificacion ? "‚òÖ" : "‚òÜ";
                        }

                        // Etiqueta de Rol
                        let etiquetaRol = "";
                        let bordeColor = "var(--color-primary)"; 

                        if (r.rol === 'Administrador') {
                            etiquetaRol = " <span style='background:#4B3832; color:white; font-size:0.7em; padding:2px 6px; border-radius:4px;'>ADMIN</span>";
                            bordeColor = "#4B3832";
                        } else if (r.rol === 'Operador') {
                            etiquetaRol = " <span style='background:#D2B48C; color:white; font-size:0.7em; padding:2px 6px; border-radius:4px;'>STAFF</span>";
                        }

                        // Formatear Fecha (MySQL suele devolver formato ISO o string)
                        let fechaMostrar = r.fecha;
                        try {
                            if(r.fecha) {
                                const fechaObj = new Date(r.fecha);
                                fechaMostrar = fechaObj.toLocaleDateString();
                            }
                        } catch(e) { console.log(e); }

                        const card = document.createElement('div');
                        card.className = "review-card";
                        card.style.borderLeft = `4px solid ${bordeColor}`;

                        card.innerHTML = `
                            <div class="review-header">
                                <span>${r.autor} ${etiquetaRol}</span>
                                <span class="review-stars">${starsHTML}</span>
                            </div>
                            <div class="review-date">${fechaMostrar}</div>
                            <p>${r.comentario}</p>
                        `;
                        reviewsContainer.appendChild(card);
                    });
                })
                .catch(error => {
                    console.error("Error cargando rese√±as:", error);
                    reviewsContainer.innerHTML = "<p>Hubo un error al cargar los comentarios.</p>";
                });
        }
    });
</script>

</body>
</html>