<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - Senza</title>
    <link rel="icon" type="image/png" href="Imagenes/Senza.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --color-primary: #D2B48C;
            --color-secondary: #4B3832;
            --color-bg: #F8F8F8;
            --card-bg: #FFFFFF;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-secondary);
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        /* --- HEADER --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 40px;
            background-color: var(--card-bg);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo { display: flex; align-items: center; gap: 10px; }
        .logo img { height: 40px; }
        .logo h1 { font-size: 1.5em; margin: 0; color: var(--color-secondary); }

        .search-bar { flex-grow: 1; max-width: 400px; margin: 0 20px; }
        .search-bar input {
            width: 100%;
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid #ddd;
            background-color: var(--color-bg);
            font-family: 'Poppins';
        }

        .main-nav ul {
            display: flex;
            list-style: none;
            gap: 20px;
            padding: 0;
            margin: 0;
            align-items: center;
        }

        .main-nav a {
            text-decoration: none;
            color: var(--color-secondary);
            font-weight: 600;
            font-size: 0.95em;
            transition: color 0.3s;
        }
        .main-nav a:hover { color: var(--color-primary); }

        .admin-btn {
            background-color: var(--color-secondary);
            color: white !important;
            padding: 6px 15px;
            border-radius: 20px;
        }
        .admin-btn:hover { background-color: var(--color-primary); }

        /* --- CONTENEDOR PRINCIPAL --- */
        .container {
            max-width: 800px;
            margin: 40px auto;
            padding: 0 20px;
        }

        /* --- TARJETAS (ESTILO UNIFICADO) --- */
        .card {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .card h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--color-secondary);
            border-bottom: 2px solid var(--color-bg);
            padding-bottom: 10px;
        }

        /* --- FORMULARIOS --- */
        label {
            font-weight: 600;
            display: block;
            margin-top: 15px;
            font-size: 0.9em;
        }

        input {
            width: 100%;
            padding: 12px;
            margin-top: 5px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-family: 'Poppins';
            box-sizing: border-box;
        }
        input:focus { outline: none; border-color: var(--color-secondary); }

        .btn-primary {
            margin-top: 25px;
            width: 100%;
            padding: 14px;
            background: var(--color-secondary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
        }
        .btn-primary:hover { background: #382D26; }

        /* --- LISTAS (DIRECCIONES Y PEDIDOS) --- */
        .list-item {
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            background: #FAFAFA;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }
        .badge-success { background: #D1F2EB; color: #27AE60; }
        .badge-warning { background: #FCF3CF; color: #F39C12; }

        .btn-icon {
            background: #FDEDEC;
            color: #E74C3C;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-icon:hover { background: #FADBD8; }

        .btn-small {
            background: var(--color-secondary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }

        /* --- RESPONSIVE --- */
        @media(max-width: 600px) {
            header { flex-direction: column; text-align: center; }
            .main-nav ul { flex-direction: column; gap: 10px; }
            .list-item { flex-direction: column; align-items: flex-start; gap: 10px; }
            .btn-icon, .btn-small { width: 100%; }
        }
    </style>
</head>

<body>

    <header>
        <div class="logo">
            <img src="Imagenes/Senza.png" alt="Senza Logo">
            <h1>Senza</h1>
        </div>

        <div class="search-bar">
            <input type="text" placeholder="Buscar productos...">
        </div>

        <nav class="main-nav">
            <ul>
                <li><a href="Inicio.html">Inicio</a></li>
                <li><a href="03-productos.html">Menú</a></li>
                <li id="adminPanelLi" style="display:none;">
                    <a href="AdminOpera.html" class="admin-btn">Panel Admin</a>
                </li>
                <li><a href="#" id="accountLink">Cuenta</a></li>
                <li id="logoutItem" style="display:none;">
                    <a href="#" id="logoutLink" style="color:#e74c3c;"><i class="fas fa-sign-out-alt"></i> Salir</a>
                </li>
            </ul>
        </nav>
    </header>

    <div class="container">

        <div class="card">
            <h2><i class="fas fa-user-circle"></i> Mi Perfil</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label>Nombre</label>
                    <input type="text" id="nombre">
                </div>
                <div>
                    <label>Teléfono</label>
                    <input type="text" id="telefono">
                </div>
                <div style="grid-column: span 2;">
                    <label>Correo Electrónico</label>
                    <input type="email" id="correo">
                </div>
            </div>
            <button id="btnGuardar" class="btn-primary">Guardar Cambios</button>
        </div>

        <div class="card">
            <h2><i class="fas fa-map-marker-alt"></i> Mis Direcciones</h2>
            <div id="listaDirecciones">
                <p style="text-align:center; color:#888;">Cargando direcciones...</p>
            </div>

            <hr style="margin: 30px 0; border:0; border-top:1px dashed #ddd;">

            <h3>Agregar Nueva Dirección</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div style="grid-column: span 2;">
                    <label>Calle</label>
                    <input type="text" id="calle">
                </div>
                <div>
                    <label>Número</label>
                    <input type="text" id="numero">
                </div>
                <div>
                    <label>CP</label>
                    <input type="text" id="codigo_postal">
                </div>
                <div>
                    <label>Colonia</label>
                    <input type="text" id="colonia">
                </div>
                <div>
                    <label>Ciudad</label>
                    <input type="text" id="ciudad">
                </div>
            </div>

            <label style="margin-top: 20px;">¿Es dirección principal?</label>
            <div style="display: flex; gap: 20px; margin-top: 10px;">
                <label style="margin:0; font-weight:normal;"><input type="radio" name="principal" value="1" style="width:auto;"> Sí</label>
                <label style="margin:0; font-weight:normal;"><input type="radio" name="principal" value="0" checked style="width:auto;"> No</label>
            </div>

            <button id="btnAgregarDireccion" class="btn-primary" style="background-color: var(--color-primary);">+ Agregar Dirección</button>
        </div>

        <div class="card">
            <h2><i class="fas fa-shopping-bag"></i> Historial de Pedidos</h2>
            <div id="listaPedidos">
                <p style="text-align:center; color:#888;">Cargando pedidos...</p>
            </div>
        </div>

    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- VALIDAR SESIÓN ---
        const usuarioId = localStorage.getItem('usuarioId');
        const nombreUsuario = localStorage.getItem('usuarioNombre');
        const rolUsuario = localStorage.getItem('usuarioRol');

        if (!usuarioId) {
            window.location.href = 'Login.html';
            return;
        }

        // --- CONFIGURAR HEADER ---
        const accountLink = document.getElementById('accountLink');
        if (nombreUsuario) {
            accountLink.textContent = nombreUsuario.split(" ")[0];
            accountLink.href = "Perfil.html";
            document.getElementById('logoutItem').style.display = 'block';

            if (rolUsuario === 'Administrador' || rolUsuario === 'Operador') {
                document.getElementById('adminPanelLi').style.display = 'block';
            }
        }

        document.getElementById('logoutLink').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.clear();
            window.location.href = 'Login.html';
        });

        // --- CARGAR PERFIL ---
        fetch(`/api/perfil/${usuarioId}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('nombre').value = data.nombre || '';
                document.getElementById('correo').value = data.correo || '';
                document.getElementById('telefono').value = data.telefono || '';
            });

        document.getElementById('btnGuardar').addEventListener('click', async () => {
            const res = await fetch('/api/perfil', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id: usuarioId,
                    nombre: document.getElementById('nombre').value,
                    correo: document.getElementById('correo').value,
                    telefono: document.getElementById('telefono').value
                })
            });
            const data = await res.json();
            alert(data.success ? '✅ Perfil actualizado correctamente' : '❌ Error al actualizar');
        });

        // --- FUNCIONES DE DIRECCIONES ---
        window.cargarDirecciones = function() {
            fetch(`/api/direcciones/${usuarioId}`)
                .then(res => res.json())
                .then(direcciones => {
                    const cont = document.getElementById('listaDirecciones');
                    cont.innerHTML = '';

                    if (!direcciones || direcciones.length === 0) {
                        cont.innerHTML = '<p style="text-align:center; color:#888;">No tienes direcciones registradas.</p>';
                        return;
                    }

                    direcciones.forEach(d => {
                        cont.innerHTML += `
                            <div class="list-item">
                                <div>
                                    <strong>${d.calle} #${d.numero || ''}</strong>
                                    ${d.principal ? '<span class="badge badge-success">Principal</span>' : ''}
                                    <br>
                                    <span style="font-size:0.9em; color:#666;">
                                        ${d.colonia}, ${d.ciudad} - CP: ${d.codigo_postal}
                                    </span>
                                </div>
                                <button onclick="eliminarDireccion(${d.id_direccion})" class="btn-icon" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                    });
                });
        };

        window.eliminarDireccion = async function(id) {
            if (!confirm('¿Seguro que deseas eliminar esta dirección?')) return;
            const res = await fetch(`/api/direcciones/${id}`, { method: 'DELETE' });
            const data = await res.json();
            if (data.success) cargarDirecciones();
            else alert('Error al eliminar');
        };

        document.getElementById('btnAgregarDireccion').addEventListener('click', async () => {
            const principal = document.querySelector('input[name="principal"]:checked').value === "1";
            
            const res = await fetch('/api/direcciones', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id_usuario: usuarioId,
                    calle: document.getElementById('calle').value,
                    numero: document.getElementById('numero').value,
                    colonia: document.getElementById('colonia').value,
                    ciudad: document.getElementById('ciudad').value,
                    codigo_postal: document.getElementById('codigo_postal').value,
                    principal
                })
            });

            const data = await res.json();
            if (data.success) {
                alert('✅ Dirección agregada');
                cargarDirecciones();
                // Limpiar campos
                ['calle','numero','colonia','ciudad','codigo_postal'].forEach(id => document.getElementById(id).value = '');
            } else {
                alert('Error al guardar dirección');
            }
        });

        // --- CARGAR PEDIDOS ---
        window.cargarPedidos = function() {
            fetch(`/api/pedidos/usuario/${usuarioId}`)
                .then(res => res.json())
                .then(pedidos => {
                    const cont = document.getElementById('listaPedidos');
                    cont.innerHTML = '';

                    if (!pedidos || pedidos.length === 0) {
                        cont.innerHTML = '<p style="text-align:center; color:#888;">No has realizado pedidos aún.</p>';
                        return;
                    }

                    pedidos.forEach(p => {
                        let badgeClass = p.estado === 'Entregado' ? 'badge-success' : 'badge-warning';
                        
                        cont.innerHTML += `
                            <div class="list-item">
                                <div>
                                    <span style="font-size:0.85em; color:#888;">${p.fecha}</span><br>
                                    <strong>Total: $${p.total.toFixed(2)}</strong><br>
                                    <span class="badge ${badgeClass}">${p.estado}</span>
                                </div>
                                <button onclick="location.href='DetallePedido.html?id=${p.id_pedido}'" class="btn-small">
                                    Ver Detalle
                                </button>
                            </div>
                        `;
                    });
                });
        };

        // INICIALIZAR
        cargarDirecciones();
        cargarPedidos();
    });
</script>

</body>
</html>