<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Método de Pago | Senza</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ... (Copia tus estilos aquí o usa el archivo anterior, lo importante es el body y script) ... */
        body { font-family: 'Poppins', sans-serif; background: #F4F6F8; color: #4B3832; margin: 0; }
        .container { max-width: 1000px; margin: 40px auto; display: grid; grid-template-columns: 1.8fr 1fr; gap: 30px; padding: 0 20px; }
        .card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.04); }
        input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-pagar { width: 100%; padding: 15px; background: #4B3832; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1.1em; }
        .payment-methods { margin-bottom: 20px; }
        .payment-methods label { display: block; margin-bottom: 10px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>Elige tu método de pago</h2>
        <div class="payment-methods">
            <label><input type="radio" name="metodo" value="tarjeta" checked> Tarjeta</label>
            <label><input type="radio" name="metodo" value="transferencia"> Transferencia</label>
            <label><input type="radio" name="metodo" value="efectivo"> Efectivo</label>
        </div>

        <div id="tarjetaForm">
            <label>Nombre en la tarjeta</label>
            <input type="text" id="nombreTarjeta">

            <label>Número de tarjeta</label>
            <input type="text" id="numeroTarjeta" maxlength="16" oninput="this.value = this.value.replace(/[^0-9]/g, '')">

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div>
                    <label>Expiración</label>
                    <input type="month" id="fecha">
                </div>
                <div>
                    <label>CVV</label>
                    <input type="password" id="cvv" maxlength="3" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                </div>
            </div>
        </div>

        <div id="transferenciaForm" style="display:none;">
            <p>Cuenta: 1234567890 (BBVA)</p>
            <input type="text" id="folioTransferencia" placeholder="Folio">
        </div>

        <div id="efectivoForm" style="display:none;"><p>Paga al recibir.</p></div>

        <button class="btn-pagar" id="btnPagar">Confirmar y Pagar</button>
    </div>

    <div class="card">
        <h3>Resumen</h3>
        <p>Total: <span id="totalPago">$0.00</span></p>
    </div>
</div>

<script>
    // Mostrar/Ocultar
    document.querySelectorAll('input[name="metodo"]').forEach(r => {
        r.addEventListener('change', () => {
            document.getElementById('tarjetaForm').style.display = r.value === 'tarjeta' ? 'block' : 'none';
            document.getElementById('transferenciaForm').style.display = r.value === 'transferencia' ? 'block' : 'none';
            document.getElementById('efectivoForm').style.display = r.value === 'efectivo' ? 'block' : 'none';
        });
    });

    // Cargar Total
    const params = new URLSearchParams(window.location.search);
    document.getElementById('totalPago').textContent = `$${parseFloat(params.get('total') || 0).toFixed(2)}`;

    // Pagar
    document.getElementById('btnPagar').addEventListener('click', async () => {
        const idPedido = params.get('id');
        if (!idPedido) return alert('Error de pedido');

        const metodo = document.querySelector('input[name="metodo"]:checked').value;

        // VALIDACIÓN DE TARJETA (CORREGIDA)
        if (metodo === 'tarjeta') {
            const num = document.getElementById('numeroTarjeta').value;
            const cvv = document.getElementById('cvv').value;
            const fechaVal = document.getElementById('fecha').value;

            if (num.length < 16) return alert('Tarjeta incompleta');
            if (cvv.length < 3) return alert('CVV incompleto');
            
            // Validar FECHA VENCIDA
            if (!fechaVal) return alert('Selecciona fecha');
            const [anio, mes] = fechaVal.split('-');
            const fechaTarjeta = new Date(parseInt(anio), parseInt(mes) - 1, 1);
            const hoy = new Date();
            const fechaActual = new Date(hoy.getFullYear(), hoy.getMonth(), 1);

            if (fechaTarjeta < fechaActual) {
                return alert('⚠️ Tarjeta vencida. Verifica la fecha.');
            }
        }

        // Enviar pago
        const res = await fetch('/api/pago', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                id_pedido: idPedido,
                metodo: metodo,
                monto: parseFloat(params.get('total'))
            })
        });
        const data = await res.json();
        if(data.success) {
            alert('¡Pago exitoso!');
            localStorage.removeItem('carrito');
            window.location.href = `DetallePedido.html?id=${idPedido}`;
        } else {
            alert('Error: ' + data.error);
        }
    });
</script>
</body>
</html>
