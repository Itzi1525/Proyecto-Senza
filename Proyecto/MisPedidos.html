<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Gestión de Pedidos | Senza</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: #F8F8F8;
    color: #4B3832;
}

.container {
    max-width: 1000px;
    margin: 40px auto;
    padding: 0 20px;
}

h2 {
    text-align: center;
    margin-bottom: 30px;
}

.card {
    background: #fff;
    padding: 18px;
    border-radius: 14px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.08);
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.estado {
    padding: 6px 14px;
    border-radius: 20px;
    font-weight: 600;
    background: #D2B48C;
}

select {
    padding: 8px;
    border-radius: 8px;
}

.btn {
    padding: 8px 16px;
    border-radius: 10px;
    border: none;
    background: #4B3832;
    color: white;
    cursor: pointer;
    font-weight: 600;
}

.btn:hover {
    opacity: 0.9;
}
</style>
</head>

<body>

<div class="container">
    <h2>Gestión de Pedidos</h2>
    <div id="listaPedidos"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const rol = localStorage.getItem('usuarioRol');
    if (rol !== 'Administrador' && rol !== 'Operador') {
        alert('Acceso denegado');
        window.location.href = 'Inicio.html';
        return;
    }

    function cargarPedidosAdmin() {
        fetch('/api/pedidos')
            .then(res => res.json())
            .then(pedidos => {
                const cont = document.getElementById('listaPedidos');
                cont.innerHTML = '';

                if (!pedidos || pedidos.length === 0) {
                    cont.innerHTML = '<p>No hay pedidos registrados.</p>';
                    return;
                }

                pedidos.forEach(p => {
                    cont.innerHTML += `
                        <div class="card">
                            <div>
                                <strong>Pedido #${p.id_pedido}</strong><br>
                                Cliente: ${p.cliente}<br>
                                Fecha: ${p.fecha}<br>
                                Total: $${p.total}<br>
                                <span class="estado">${p.estado}</span>
                            </div>

                            <div>
                                <select onchange="cambiarEstado(${p.id_pedido}, this.value)">
                                    <option disabled selected>Cambiar estado</option>
                                    <option>Pendiente</option>
                                    <option>Pagado</option>
                                    <option>En preparación</option>
                                    <option>Enviado</option>
                                    <option>Entregado</option>
                                </select>

                                <button class="btn" onclick="verPedido(${p.id_pedido})">
                                    Ver detalle
                                </button>
                            </div>
                        </div>
                    `;
                });
            });
    }

    window.cambiarEstado = async (id_pedido, estado) => {
        const res = await fetch('/api/pedido/estado', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id_pedido, estado })
        });

        const data = await res.json();
        if (data.success) {
            alert('Estado actualizado');
            cargarPedidosAdmin();
        } else {
            alert('Error al cambiar estado');
        }
    };

    window.verPedido = (id) => {
        window.location.href = `DetallePedido.html?id=${id}`;
    };

    cargarPedidosAdmin();
});
</script>

</body>
</html>
